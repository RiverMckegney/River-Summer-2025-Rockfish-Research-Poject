---
title: "SU_25_River_Rockfish_Proj_Ambient_V0.3_Fec-Class_Summary"
author: "River Mckegney"
date: "`r Sys.Date()`"
output: html_document
---





## Setup, and Packages

```{r setup, include=FALSE}
# Setup
knitr::opts_chunk$set(echo = TRUE)
```

Code Packages:
```{r packages}
# Load packages
library(gridExtra) # For using grid.table to save tables as images
library(flextable) # Alternative method to save df as image
library(tidyverse)
library(zoo)
library(lme4)
library(lmerTest)
library(rlang)
library(nortest) # For ad.test
library(car) # For homogeneity of variance with leveneTest
library(rcompanion) # For scheirerRayHare test
library(pastecs) # For stat.desc
library(ggpubr) # For assumption plots
library(conover.test) # For the conover.Iman() test function
library(DescTools) # Contain alternative ConoverTest function
library(rstatix) # tidyverse adapted stat tests and mshapiro_test() functions
library(DHARMa) # For multi-level lm models and shapiro test
library(patchwork) # For combining ggplots
```



## Data Entry: Read-in data

```{r}
# Read and call data into df

# Primary samples df
ABL90 <- read.csv("Raw_Data/ABL90_Raw.csv")

# River's Parturition metadata
partuition_subcat <- read.csv("Raw_Data/River's_Rockfish_Metadata_Parturition_V7.csv")

```


## Data Filtering

```{r}
# Data sifting: ABL90 dataset

# Step 1: Remove missing info
ABL_set1 <- ABL90 %>%
  filter(Patient.ID_edited != "") 
  

# Step 2: Separate Patient.ID into columns of sample types: blood plasma and instant freeze plasma 
ABL_set2 <- separate(ABL_set1, 'Patient.ID_edited', into = c("Patient.ID_edited", "Sample_Type"), sep = ",")  


# Step 3:
# Convert Patient.ID_edited column data to character type
ABL_set2$Patient.ID_edited <- as.character(ABL_set2$Patient.ID_edited) 

```


```{r}
# Step 4 & 5: Sussing out specific sample errors  

# Remove insufficient samples
ABL_set3 <- ABL_set2 %>%
  filter(!is.na("Type")) %>%
  filter(!str_detect(Errors.detected.during.measurement, "Insufficient sample"))

# Remove inhomogeneous samples
ABL_set3 <- ABL_set3 %>%
  filter(!is.na("Type")) %>%
  filter(!str_detect(Errors.detected.during.measurement, "Inhomogeneous sample"))

# Step 6: Filter for only blood samples
ABL_b_samp <- ABL_set3 %>%
  filter(Sample_Type == "b")

```


## Merge Datasets:

Join ABL90 df with parturition_subcat df: Making ABL_merged
```{r}
# Rename columns to match: Change 'ID' in parturition_subcat to 'Patient.ID_edited' so it is ready to join with ABL90 df

# Please note the 'Treatment' col in parturition_subcat does not match with the finalized 'Ambient.Or.OAH' col in metadata_atresia_guide or ABL90_merged df

# Rename 'ID' col to 'patient.ID_edited'
partuition_subcat <- partuition_subcat %>%
  rename(Patient.ID_edited = ID)

```

```{r}
# Connect main ABL90 dataset with my (River's) sub categorized parturition metadata 
# ABL_merged <- partuition_subcat %>%
# left_join(ABL_b_samp, by = "Patient.ID_edited")

ABL_merged <- ABL_b_samp %>%
inner_join(partuition_subcat, by = "Patient.ID_edited")
```

Rename Columns Neatly:
```{r}
# Rename Treatment & Parturition Outcome
ABL_merged <- ABL_merged %>%
  rename(Ambient.Or.OAH = Consensus_General_Treatment,
         Pregnant.Or.Atresia = Consensus_Atresia_Or_Pregnant)
         
```


## Remove Samples: Mortalities, NA's, or Missing Info, and Replicates

Remove Replicate ID's
```{r}
# Cross Check all Columns: Cross validation to suss correct replicate row
check_params <- ABL_merged %>%
  select(Patient.ID_edited, Time, Sample.., Measuring.Mode, Ambient.Or.OAH, Pregnant.Or.Atresia, pH, Glu..mmol.L., Hct...., Na...mmol.L., Cl...mmol.L., K...mmol.L., Ca....mmol.L., pCO2..mmHg.) %>%
  filter(Patient.ID_edited == "9782D")
print(check_params)

check_params <- ABL_merged %>%
  select(Patient.ID_edited, Time, Sample.., Measuring.Mode, Ambient.Or.OAH, Pregnant.Or.Atresia, pH, Glu..mmol.L., Hct...., Na...mmol.L., Cl...mmol.L., K...mmol.L., Ca....mmol.L., pCO2..mmHg.) %>%
  filter(Patient.ID_edited == "9783D")
print(check_params)

# Removed replicates: 9782D (2x) and 9783D (2x)
ABL_merged <- ABL_merged %>%
  filter(Sample.. != "863",
         Sample.. != "934")

```

Review Replicates: 

| Row | ID | Time | Sample.. | Measuring.Mode | pH | Glu.mmol.L. | Hct.... | Na...mmol.L. | Cl...mmol.L. | K...mmol.L. | Ca.mmol.L. |
|:------:| :-----: | :-----: | :-----:| :------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|
| 32 | 9782D | 12/28/2023 10:04 | 1016 | C 65uL | 7.348 | 0.5 | 9.8 | 184 | 149 | 2.8 | 1.32 |
| 39 | 9782D | 1/9/2024 17:21 | 863 | S 65uL | 7.446 | 0.7 | 13.3 | 181 | 161 | 2.9 | 1.31 |  
| 36 | 9783D | 1/19/2024 10:37 | 934 | S 65uL | 7.484 | 1.7 | **0.2** | 175 | 193 | **34.5** | 1.29 |
| 41 | 9783D | 1/7/2024 12:32 | 860 | S 65uL | 7.450 | 1.3 | **14.7** | 179 | 164 | **2.5** | 1.30 |

Methods for replicate sample removal:
Check processing date of IDs, and remove samples that do not match that date.

Case ID_9782D:

- Origianl ABL90 set contains:
- 9782D,b (Sample.. 1016, Time = 12/28/2023  10:04:00 AM) 
- 9782D,p (Sample.. 1020, Time = 12/28/2023  10:25:00 AM)
- 9782D,p (Sample.. 865, Time = 1/9/2024  5:29:00 PM)
- 9782D,b (Sample.. 863, Time = 1/9/2024  5:21:00 PM)

- 2024_Fish_Metadata.csv says ID_9782D was processed 3/29/2024


- Note Processing date in metadata will not match time date stamp in ABL90 data due to the machine being reset, and innacurrate dates being automatically recorded.

Deciding info:
- For ID-9782D, refer to metadata sheet and look for other samples with that same processing date, then view thoes samples ABL90 'Time'. Try to find a matching 'Time' with other IDs and 9782D that were processed together during the same time recorded by the machine. 

- ID_97838,b (single obs, Sample.. 1024) Time = 12/28/2023  11:49:00 AM

- Since 9782D,b Sample.. 1016 and 97838,b Sample.. 1024 both have a date timestamp occurrence on 12/28/2023, I have decided to keep 9782D,b Sample.. 1016 and drop 9783D,b Sample.. 863


Case ID_9783D

- Original ABL90 dataset contains:
- 9783D,b (Sample.. 934, Time = 1/19/2024  10:37:00 AM)
- 9783D,c (Sample.. 861, Time = 1/7/2024  12:38:00 PM)
- 9783D,b (Sample.. 860, Time = 1/7/2024  12:32:00 PM)

- 2024_Fish_Metadata.csv says ID_9783D was processed 3/20/2024

- Informed that ID_9783D: Sample.. 934 is a plasma sample (on account of its low hct value), remove this and **keep Sample.. 860 (parameter values appear correct)**.


# Samples: Data subsets

Remove Motalities and No info IDs and assign analysis ready data-frames:
```{r}

# New df with Moralities removed: Note none of these samples made it into ABL90 df anyway, so looks like they are already filtered out.
 Live_Samples <- ABL_merged %>%
  filter(Patient.ID_edited != "9780C", # Mortality
         Patient.ID_edited != "777AE", # Mortality
         Patient.ID_edited != "777CA") # Mortality after parturition


# New df with mortality and 'No info' Id's removed
 Primary_Samples <- Live_Samples %>%
   filter(Patient.ID_edited != "777A0", # No info
           Patient.ID_edited != "9782F", # No info
           Patient.ID_edited != "777B3", # No info
           Patient.ID_edited != "777AA", # No info
           Patient.ID_edited != "777DE", # No info
           Patient.ID_edited != "777CE", # No info
           Patient.ID_edited != "777A6") # No info
 
 
# New df of Only Ambient Treatment: For testing parturition success
 Ambient_Samples <- Primary_Samples %>%
   filter(Ambient.Or.OAH == "Ambient")
 
# New df of Fecundity Samples:
 Fecundity_Samples <- Primary_Samples %>%
   filter(Fecundity_Or_Brood_Count != "NA",
     Fecundity_Class != "NA") # removes 97706

# Fecundity samples without atresia Ids
 Fecundity_No_Atresia_Samples <- Primary_Samples %>%
   filter(All_Fecundity != "Na",
          All_Fecundity != 0)  # removes atresia IDs

# Fecundity Ambient Samples
 Amb_Fec_Samples <- Primary_Samples %>%
   filter(Ambient.Or.OAH == "Ambient",
          All_Fecundity != "NA") # removes OAH treatment samples and ID 97706
 
# Fecundity Ambient Samples without atresia Ids
 Amb_Fec_No_Atresia_Samples <- Primary_Samples %>%
   filter(Ambient.Or.OAH == "Ambient", # removes OAH treatment 
          All_Fecundity != "NA", # removes all missing info IDs
          All_Fecundity != 0) # removes atresia IDs
 
```


Change Data Types:
```{r}
# Change Continuous Data to type to numeric, double, or factor

# Change data type of ions to factor or numeric
#glimpse(General_Samples)
#glimpse(Ambient_Samples)
 
Primary_Samples <- Primary_Samples %>%
  mutate(across(c(All_Fecundity, pH, Hct...., Glu..mmol.L., Na...mmol.L., Cl...mmol.L., K...mmol.L., Ca....mmol.L.), as.numeric))

Ambient_Samples <- Ambient_Samples %>%
  mutate(across(c(All_Fecundity, pH, Hct...., Glu..mmol.L., Na...mmol.L., Cl...mmol.L., K...mmol.L., Ca....mmol.L.), as.numeric))

Fecundity_Samples <- Fecundity_Samples %>%
  mutate(across(c(All_Fecundity, pH, Hct...., Glu..mmol.L., Na...mmol.L., Cl...mmol.L., K...mmol.L., Ca....mmol.L.), as.numeric))

Fecundity_No_Atresia_Samples <- Fecundity_Samples %>%
  mutate(across(c(All_Fecundity, pH, Hct...., Glu..mmol.L., Na...mmol.L., Cl...mmol.L., K...mmol.L., Ca....mmol.L.), as.numeric))

Amb_Fec_Samples <- Amb_Fec_Samples %>%
  mutate(across(c(All_Fecundity, pH, Hct...., Glu..mmol.L., Na...mmol.L., Cl...mmol.L., K...mmol.L., Ca....mmol.L.), as.numeric))
  
Amb_Fec_No_Atresia_Samples <- Amb_Fec_No_Atresia_Samples %>%
  mutate(across(c(All_Fecundity, pH, Hct...., Glu..mmol.L., Na...mmol.L., Cl...mmol.L., K...mmol.L., Ca....mmol.L.), as.numeric))

# glimpse(Primary_Samples)
# glimpse(Ambient_Samples)
# glimpse(Fecundity_Samples)
# glimpse(Amb_Fec_Samples)

```



## Order Factor Levels
```{r}
# Fecundity data 

#unique(Fecundity_Samples$Fecundity_Class)

# Arrange the order of parturition categories for visualizations & tests

# Primary Samples

# Arrange Treatment
Primary_Samples$Ambient.Or.OAH <- ordered(Primary_Samples$Ambient.Or.OAH, levels = c("Ambient", "OAH"))

# Arrange Parturition outcome
Primary_Samples$Pregnant.Or.Atresia <- ordered(Primary_Samples$Pregnant.Or.Atresia, levels = c("Post Parturition", "Atresia"))

# Arrange Brood Condition
Primary_Samples$Consensus_Brood_Condition <- ordered(Primary_Samples$Consensus_Brood_Condition, levels = c("Excellent", "Normal", "Low", "Very Low", "Atresia"))

# Arrange Fecundity Class
Primary_Samples$Fecundity_Class <- ordered(Primary_Samples$Fecundity_Class, levels = c("High (>50,000)", "Low (~1,000s)", "Atresia"))

# Remove NAs from ordered character factors
Primary_Samples <- Primary_Samples %>%
  filter(Fecundity_Class != is.na(Fecundity_Class)) %>%
  filter(Consensus_Brood_Condition != is.na(Consensus_Brood_Condition))
 
 
# Ambient data
Ambient_Samples$Ambient.Or.OAH <- ordered(Ambient_Samples$Ambient.Or.OAH, levels = c("Ambient", "OAH"))

Ambient_Samples$Pregnant.Or.Atresia <- ordered(Ambient_Samples$Pregnant.Or.Atresia, levels = c("Post Parturition", "Atresia"))

Ambient_Samples$Consensus_Brood_Condition <- ordered(Ambient_Samples$Consensus_Brood_Condition, levels = c("Excellent", "Normal", "Low", "Atresia"))

Ambient_Samples$Fecundity_Class <- ordered(Ambient_Samples$Fecundity_Class, levels = c("High (>50,000)", "Low (~1,000s)", "Atresia"))

# Remove NAs from ordered character factors
Ambient_Samples <- Ambient_Samples %>%
  filter(Fecundity_Class != is.na(Fecundity_Class)) %>%
  filter(Consensus_Brood_Condition != is.na(Consensus_Brood_Condition))

# Ambient Fecundity data
Amb_Fec_No_Atresia_Samples$Ambient.Or.OAH <- ordered(Amb_Fec_No_Atresia_Samples$Ambient.Or.OAH, levels = c("Ambient", "OAH"))

Amb_Fec_No_Atresia_Samples$Pregnant.Or.Atresia <- ordered(Amb_Fec_No_Atresia_Samples$Pregnant.Or.Atresia, levels = c("Post Parturition", "Atresia"))

Amb_Fec_No_Atresia_Samples$Consensus_Brood_Condition <- ordered(Amb_Fec_No_Atresia_Samples$Consensus_Brood_Condition, levels = c("Excellent", "Normal", "Low", "Atresia"))

Amb_Fec_No_Atresia_Samples$Fecundity_Class <- ordered(Amb_Fec_No_Atresia_Samples$Fecundity_Class, levels = c("High (>50,000)", "Low (~1,000s)", "Atresia"))

# Remove NAs from ordered character factors
Amb_Fec_No_Atresia_Samples <- Amb_Fec_No_Atresia_Samples %>%
  filter(Fecundity_Class != is.na(Fecundity_Class)) %>%
  filter(Consensus_Brood_Condition != is.na(Consensus_Brood_Condition))

```



# Save filtered dataset into data-worked folder
```{r}
# Save merged dataset in a worked folder

write.csv(x = Primary_Samples, file = "Worked-Data/Primary_Samples")

write.csv(x = Ambient_Samples, file = "Worked-Data/Ambient_Samples")

write.csv(x = Fecundity_Samples, file = "Worked-Data/Fecundity_Samples")

write.csv(x = Fecundity_No_Atresia_Samples, file = "Worked-Data/Fecundity_No_Atresia_Samples")

write.csv(x = Amb_Fec_Samples, file = "Worked-Data/Amb-Fec_Samples")

write.csv(x = Amb_Fec_No_Atresia_Samples, file = "Worked-Data/Amb_Fec_No_Atresia_Samples")

```


## Sample Size: n
```{r}
# Sample Size

# Ambient data:
ambient_sample_size_table <- Ambient_Samples %>%
  group_by(Ambient.Or.OAH, Consensus_Brood_Condition) %>%
  summarise(n_size = n_distinct(Patient.ID_edited), .groups = "drop")
print(ambient_sample_size_table)

 pdf("data-images/ambient_sample_size_table.pdf")
 grid.table(ambient_sample_size_table)
 dev.off()
 
 png("data-images/ambient_sample_size_table.png")
 grid.table(ambient_sample_size_table)
 dev.off()

 
ambient_fecundity_class_sample_size_table <- Ambient_Samples %>%
  group_by(Ambient.Or.OAH, Fecundity_Class) %>%
  summarise(n_size = n_distinct(Patient.ID_edited), .groups = "drop")
print(ambient_fecundity_class_sample_size_table)

 pdf("data-images/ambient_fecundity_class_sample_size_table.pdf")
 grid.table(ambient_fecundity_class_sample_size_table)
 dev.off()
 
 png("data-images/ambient_fecundity_class_sample_size_table.png")
 grid.table(ambient_fecundity_class_sample_size_table)
 dev.off()

amb_fec_no_atresia_sample_size_table <- Amb_Fec_No_Atresia_Samples %>%
  group_by(Ambient.Or.OAH, Weight_Adjusted_Fecundity_Fecundity.Mean_Weight) %>%
  summarise(n_size = n_distinct(Patient.ID_edited), .groups = "drop")
print(amb_fec_no_atresia_sample_size_table)
 
```


Sample Size Barplot:
```{r}
# View Sample Distributions
# Sample Size barplot
# Ambient Samples

# Consensus brood condition sample barplot
ambient_sample_size_barplot <- Ambient_Samples %>%
  group_by(Consensus_Brood_Condition, Ambient.Or.OAH) %>% 
  summarise(n_size = n_distinct(Patient.ID_edited), .groups = "drop") %>%
  ggplot(aes(x = Consensus_Brood_Condition, y = n_size)) +
  geom_bar(stat = "identity") +
  facet_grid(~ Ambient.Or.OAH) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 15.5), breaks = c(0, 3, 6, 9, 12, 15)) +
  labs(title = "Ambient Sample Size",
        x = "Parturition Outcome",
        y = "Sample Size (n)") +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))
print(ambient_sample_size_barplot)

ggsave(filename = "data-images/.png", plot = ambient_sample_size_barplot, device = "png")
ggsave(filename = "data-images/ambient_sample_size_barplot.pdf", plot = ambient_sample_size_barplot, device = "pdf")


# Fecundity class sample barplot
ambient_sample_size_barplot2 <- Ambient_Samples %>%
  group_by(Fecundity_Class, Ambient.Or.OAH) %>% 
  summarise(n_size = n_distinct(Patient.ID_edited), .groups = "drop") %>%
  ggplot(aes(x = Fecundity_Class, y = n_size)) +
  geom_bar(stat = "identity") +
  facet_grid(~ Ambient.Or.OAH) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 15.5), breaks = c(0, 3, 6, 9, 12, 15)) +
  labs(title = "Ambient Sample Size",
        x = "Parturition Outcome",
        y = "Sample Size (n)") +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))
print(ambient_sample_size_barplot2)

ggsave(filename = "data-images/.png", plot = ambient_sample_size_barplot2, device = "png")
ggsave(filename = "data-images/ambient_sample_size_barplot2.pdf", plot = ambient_sample_size_barplot2, device = "pdf")

# Amb Fec No atresia sample size

amb_fec_no_atresia_barplot <- Amb_Fec_No_Atresia_Samples %>%
  group_by(Fecundity_Class, Ambient.Or.OAH) %>% 
  summarise(n_size = n_distinct(Patient.ID_edited), .groups = "drop") %>%
  ggplot(aes(x = Fecundity_Class, y = n_size)) +
  geom_bar(stat = "identity") +
  facet_grid(~ Ambient.Or.OAH) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 15.5), breaks = c(4, 8, 12)) +
  labs(title = "Ambient No Atresia Sample Size",
        x = "Parturition Outcome",
        y = "Sample Size (n)") +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))
print(amb_fec_no_atresia_barplot)

ggsave(filename = "data-images/.png", plot = amb_fec_no_atresia_barplot, device = "png")
ggsave(filename = "data-images/amb_fec_no_atresia_barplot.pdf", plot = amb_fec_no_atresia_barplot, device = "pdf")

```


## Paramater Analysis:


# pH

pH boxplot
```{r}

pH_ambient_fec_class_boxplot <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = pH)) +
  geom_point(aes(x = Fecundity_Class, y = pH), alpha = 0.5, colour = "black") +
  labs(title = "pH", x = "Fecundity Class", y = "pH") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(pH_ambient_fec_class_boxplot)

ggsave(filename = "data-images/pH_ambient_fec_class_boxplot.pdf", plot = pH_ambient_fec_class_boxplot, device = "pdf")
ggsave(filename = "data-images/pH_ambient_fec_class_boxplot.png", plot = pH_ambient_fec_class_boxplot, device = "png")

# Ambient No Atresia Samples Scatterplot
pH_amb_fec_no_atresia_scatterplot <- Amb_Fec_No_Atresia_Samples %>%
  ggplot() + 
  geom_point(aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = pH), colour = "black") +
  labs(title = "pH", x = "Weight Adjusted Fecundity", y = "pH") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(pH_amb_fec_no_atresia_scatterplot)

ggsave(filename = "data-images/pH_amb_fec_no_atresia_scatterplot.pdf", plot = pH_amb_fec_no_atresia_scatterplot, device = "pdf")
ggsave(filename = "data-images/pH_amb_fec_no_atresia_scatterplot.png", plot = pH_amb_fec_no_atresia_scatterplot, device = "png")

```



# pH Stat Tests

Differences: Between Fecundity Class
```{r}
# pH
# Ambient ANOVA Test

# Testing for differences in ambient parturition success metrics
# One-way ANOVA (parametric) or Kruskal-Wallis test (nonparametric)

pH_aov_ambient_fec <- aov(pH ~ Fecundity_Class, data = Ambient_Samples)
summary(pH_aov_ambient_fec)


# If significant, Post Hoc Test: 
# - Tukey's HSD (parametric, normality & equal variance across groups)
# - Dunn's test (non-parametric, after Kruskal-Wallis test)

TukeyHSD(pH_aov_ambient_fec)


pH_ambient_fec_sim <- simulateResiduals(fittedModel = pH_aov_ambient_fec) 
plot(pH_ambient_fec_sim)

plotResiduals(pH_ambient_fec_sim)

testDispersion(pH_ambient_fec_sim)

testOutliers(pH_ambient_fec_sim)  
outlierTest(pH_aov_ambient_fec)

# Parametric tests

# Normality
shapiro.test(Ambient_Samples$pH)

shapiro.test(residuals(aov(pH ~ Fecundity_Class, data = Ambient_Samples)))

# QQplot:
pH_ambient_fec_res_qqplot <- ggqqplot(residuals(aov(pH ~ Fecundity_Class, data = Ambient_Samples))) +
labs(title = "Ambient pH Residual QQplot",
     subtitle = "residuals(aov(pH ~ Fecundity_Class, data = Ambient_Samples))",
                               x = "pH Theoretical Quantiles (Predicted values)",
                               y = "pH Sample Quantiles") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
print(pH_ambient_fec_res_qqplot)


# Parametric Variance test (Bartlett's test): require at least 2 obs for each group
bartlett.test(pH ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric variance test (Levene's test):
leveneTest(pH ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric stat test: Kruskall Wallis
kruskal.test(pH ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric Post Hoc: Dunn's test
DunnTest(pH ~ Fecundity_Class, data = Ambient_Samples)

```


Correlations: Parameter to Numerical Fecundity (without Atresia IDs)
```{r}
# Ph
# Linear Model
pH_amb_fec_no_atresia_lm <- lm(pH ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)
summary(pH_amb_fec_no_atresia_lm)

pH_ambient_sim <- simulateResiduals(fittedModel = pH_amb_fec_no_atresia_lm) 
plot(pH_ambient_sim)

plotResiduals(pH_amb_fec_no_atresia_lm)

testDispersion(pH_amb_fec_no_atresia_lm)

testOutliers(pH_ambient_sim)  
outlierTest(pH_amb_fec_no_atresia_lm)

# Normality test
shapiro.test(residuals(pH_amb_fec_no_atresia_lm))

# qq plot
ggqqplot(residuals(lm(pH ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)))

# Transform data: square root (undo log scale?)
pH_ambient_sqrt <- Amb_Fec_No_Atresia_Samples %>%
  mutate(pH = sqrt(pH))

# Rerun lm model with square root transformed data
pH_amb_fec_no_atresia_lm_sqrt <- lm(pH ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = pH_ambient_sqrt)
summary(pH_amb_fec_no_atresia_lm_sqrt)

pH_amb_fec_sqrt_sim <- simulateResiduals(fittedModel = pH_amb_fec_no_atresia_lm_sqrt) 
plot(pH_amb_fec_sqrt_sim)

plotResiduals(pH_amb_fec_no_atresia_lm_sqrt)

testDispersion(pH_amb_fec_no_atresia_lm_sqrt)

# Residuals of model for shapiro test
pH_amb_fec_no_atresia_lm_res <- residuals(pH_amb_fec_no_atresia_lm_sqrt) 

# Normality test
shapiro.test(pH_amb_fec_no_atresia_lm_res) # normal


# Parametric variance test: bartlett's test
# Require at least 2 obs for each group
#bartlett.test(pH ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Fecundity_No_Atresia_Samples) 

# Nonparametric variance test (Levene's test)
# NA for quantitative explanatory variables
# leveneTest(pH ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Fecundity_No_Atresia_Samples)

```


Residuals Plot (if significant)
```{r}
# pH
# Ambient samples

# ggplot with geom_smooth(aes(x=,y=)), method = "lm")

# Original lm model (no transformation)
pH_ambient_lm_scatterplot <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = pH)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "pH", x = "Weight Adjusted Fecudnity", y = "pH", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        plot.title = element_text(size = 25, hjust = 0.5),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(pH_ambient_lm_scatterplot)

ggsave(filename = "data-images/pH_ambient_lm_scatterplot.pdf", plot = pH_ambient_lm_scatterplot, device = "pdf")
ggsave(filename = "data-images/pH_ambient_lm_scatterplot.png", plot = pH_ambient_lm_scatterplot, device = "png")

# Square root transformed model
pH_ambient_lm_scatterplot2 <- ggplot(data = pH_ambient_sqrt, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = pH)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "pH", x = "Weight Adjusted Fecudnity", y = "Sqrt pH", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        plot.title = element_text(size = 25, hjust = 0.5),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(pH_ambient_lm_scatterplot2)

```



# Hematocrit 

```{r}
# hct

# Hct boxplot
hct_ambient_fec_class_boxplot <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Hct....)) +
  geom_point(aes(x = Fecundity_Class, y = Hct....), alpha = 0.5, colour = "black") +
  labs(title = "Hematocrit", x = "Fecundity Class", y = "Hematocrit (%)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(hct_ambient_fec_class_boxplot)

ggsave(filename = "data-images/hct_ambient_fec_class_boxplot.pdf", plot = hct_ambient_fec_class_boxplot, device = "pdf")
ggsave(filename = "data-images/hct_ambient_fec_class_boxplot.png", plot = hct_ambient_fec_class_boxplot, device = "png")

# Ambient No Atresia Sample Scatterplot
hct_amb_fec_no_atresia_scatterplot <- Amb_Fec_No_Atresia_Samples %>%
  ggplot() + 
  geom_point(aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Hct....), colour = "black") +
  labs(title = "Hematocrit", x = "Weight Adjusted Fecundity", y = "Hematocrit (%)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(hct_amb_fec_no_atresia_scatterplot)

ggsave(filename = "data-images/hct_amb_fec_no_atresia_scatterplot.pdf", plot = hct_amb_fec_no_atresia_scatterplot, device = "pdf")
ggsave(filename = "data-images/hct_amb_fec_no_atresia_scatterplot.png", plot = hct_amb_fec_no_atresia_scatterplot, device = "png")
```


# Hct Stat Tests

Differences: Between Fecundity Class
```{r}
# hct
# Ambient ANOVA Test

# Testing for differences in ambient parturition success metrics
# One-way ANOVA (parametric) or Kruskal-Wallis test (nonparametric)

hct_aov_ambient_fec <- aov(Hct.... ~ Fecundity_Class, data = Ambient_Samples)
summary(hct_aov_ambient_fec)


# If significant, Post Hoc Test: 
# - Tukey's HSD (parametric, normality & equal variance across groups)
# - Dunn's test (non-parametric, after Kruskal-Wallis test)

TukeyHSD(hct_aov_ambient_fec)


hct_ambient_fec_sim <- simulateResiduals(fittedModel = hct_aov_ambient_fec) 
plot(hct_ambient_fec_sim)

plotResiduals(hct_ambient_fec_sim)

testDispersion(hct_ambient_fec_sim)

testOutliers(hct_ambient_fec_sim)  
outlierTest(hct_aov_ambient_fec)

# Parametric tests

# Normality
shapiro.test(Ambient_Samples$Hct....)

shapiro.test(residuals(aov(Hct.... ~ Fecundity_Class, data = Ambient_Samples)))

# QQplot:
hct_ambient_fec_res_qqplot <- ggqqplot(residuals(aov(Hct.... ~ Fecundity_Class, data = Ambient_Samples))) +
labs(title = "Ambient Hematocrit Residual QQplot",
     subtitle = "residuals(aov(Hct.... ~ Fecundity_Class, data = Ambient_Samples))",
                               x = "Hct Theoretical Quantiles (Predicted values)",
                               y = "Hct Sample Quantiles") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
print(hct_ambient_fec_res_qqplot)


# Parametric Variance test (Bartlett's test): require at least 2 obs for each group
bartlett.test(Hct.... ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric variance test (Levene's test):
leveneTest(Hct.... ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric stat test: Kruskall Wallis
kruskal.test(Hct.... ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric Post Hoc: Dunn's Test
DunnTest(Hct.... ~ Fecundity_Class, data = Ambient_Samples)

```

Correlations: Parameter to Numerical Fecundity (without Atresia IDs)
```{r}
# hct
# Linear Model
hct_amb_fec_no_atresia_lm <- lm(Hct.... ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)
summary(hct_amb_fec_no_atresia_lm)

hct_ambient_sim <- simulateResiduals(fittedModel = hct_amb_fec_no_atresia_lm) 
plot(hct_ambient_sim)

plotResiduals(hct_amb_fec_no_atresia_lm)

testDispersion(hct_amb_fec_no_atresia_lm)

testOutliers(hct_ambient_sim)  
outlierTest(hct_amb_fec_no_atresia_lm)

# Normality test
shapiro.test(residuals(hct_amb_fec_no_atresia_lm))

# qq plot
ggqqplot(residuals(lm(Hct.... ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)))

# Transform data: square root (undo log scale?)
hct_ambient_sqrt <- Ambient_Samples %>%
  mutate(Hct.... = sqrt(Hct....))

# Rerun lm model with square root transformed data
hct_amb_fec_no_atresia_lm_sqrt <- lm(Hct.... ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = hct_ambient_sqrt)
summary(hct_amb_fec_no_atresia_lm_sqrt)

hct_amb_fec_sqrt_sim <- simulateResiduals(fittedModel = hct_amb_fec_no_atresia_lm_sqrt) 
plot(hct_amb_fec_sqrt_sim)

plotResiduals(hct_amb_fec_no_atresia_lm_sqrt)

testDispersion(hct_amb_fec_no_atresia_lm_sqrt)

# Residuals of model for shapiro test
hct_amb_sqrt_res <- residuals(hct_amb_fec_no_atresia_lm_sqrt) 

# Normality test
shapiro.test(hct_amb_sqrt_res) 


# Parametric variance test: bartlett's test
# Require at least 2 obs for each group
#bartlett.test(Hct.... ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = hct_ambient_sqrt) 

# Nonparametric variance test (Levene's test)
# NA for quantitative explanatory variables
# leveneTest(Hct.... ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = hct_ambient_sqrt)

```

Residuals Plot (if significant)
```{r}
# hct
# Ambient samples

# ggplot with geom_smooth(aes(x=,y=)), method = "lm")

hct_ambient_lm_scatterplot <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Hct....)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Hematocrit", x = "Weight Adjusted Fecudnity", y = "Hematocrit (%)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        plot.title = element_text(size = 25, hjust = 0.5),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(hct_ambient_lm_scatterplot)

ggsave(filename = "data-images/hct_ambient_lm_scatterplot.pdf", plot = hct_ambient_lm_scatterplot, device = "pdf")
ggsave(filename = "data-images/hct_ambient_lm_scatterplot.png", plot = hct_ambient_lm_scatterplot, device = "png")

```


# Glucose 

Glucose graphs
```{r}
# Glucose

# Glucose boxplot 
glucose_ambient_fec_class_boxplot <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Glu..mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = Glu..mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Glucose", x = "Fecundity Class", y = "Glucose (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(glucose_ambient_fec_class_boxplot)

ggsave(filename = "data-images/glucose_ambient_fec_class_boxplot.pdf", plot = glucose_ambient_fec_class_boxplot, device = "pdf")
ggsave(filename = "data-images/glucose_ambient_fec_class_boxplot.png", plot = glucose_ambient_fec_class_boxplot, device = "png")

# Glucose Ambient No Atresia Scatterplot
glucose_amb_fec_no_atresia_scatterplot <- Amb_Fec_No_Atresia_Samples %>%
  ggplot() + 
  geom_point(aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Glu..mmol.L.), colour = "black") +
  labs(title = "Glucose", x = "Weight Adjusted Fecundity", y = "Glucose (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(glucose_amb_fec_no_atresia_scatterplot)

ggsave(filename = "data-images/glucose_amb_fec_no_atresia_scatterplot.pdf", plot = glucose_amb_fec_no_atresia_scatterplot, device = "pdf")
ggsave(filename = "data-images/glucose_amb_fec_no_atresia_scatterplot.pdf", plot = glucose_amb_fec_no_atresia_scatterplot, device = "png")

```


# Glucose Stat Tests

Differences: Between Fecundity Class
```{r}
# glucose
# Ambient ANOVA Test

# Testing for differences in ambient parturition success metrics
# One-way ANOVA (parametric) or Kruskal-Wallis test (nonparametric)

glucose_aov_ambient_fec <- aov(Glu..mmol.L. ~ Fecundity_Class, data = Ambient_Samples)
summary(glucose_aov_ambient_fec)


# If significant, Post Hoc Test: 
# - Tukey's HSD (parametric, normality & equal variance across groups)
# - Dunn's test (non-parametric, after Kruskal-Wallis test)

TukeyHSD(glucose_aov_ambient_fec)

glu_ambient_fec_sim <- simulateResiduals(fittedModel = glucose_aov_ambient_fec) 
plot(glu_ambient_fec_sim)

plotResiduals(glu_ambient_fec_sim)

testDispersion(glu_ambient_fec_sim)

testOutliers(glu_ambient_fec_sim)  
outlierTest(glucose_aov_ambient_fec)


# Parametric tests

# Normality
shapiro.test(Ambient_Samples$Glu..mmol.L.)

shapiro.test(residuals(aov(Glu..mmol.L. ~ Fecundity_Class, data = Ambient_Samples)))

# QQplot:
glucose_ambient_fec_res_qqplot <- ggqqplot(residuals(aov(Glu..mmol.L. ~ Fecundity_Class, data = Ambient_Samples))) +
labs(title = "Ambient Glucose Interactive Residual QQplot",
     subtitle = "residuals(aov(Glu..mmol.L. ~ Fecundity_Class, data = Ambient_Samples))",
                               x = "Glucose Theoretical Quantiles (Predicted values)",
                               y = "Glucose Sample Quantiles") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
print(glucose_ambient_fec_res_qqplot)


# Parametric Variance test (Bartlett's test): require at least 2 obs for each group
bartlett.test(Glu..mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric variance test (Levene's test):
leveneTest(Glu..mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric stat test: Kruskall Wallis
kruskal.test(Glu..mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric Post Hoc: Dunn's test
DunnTest(Glu..mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

```


Correlations: Parameter to Numerical Fecundity (without Atresia IDs)
```{r}
# glucose
# Linear Model
glucose_amb_fec_no_atresia_lm <- lm(Glu..mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)
summary(glucose_amb_fec_no_atresia_lm)

glucose_ambient_sim <- simulateResiduals(fittedModel = glucose_amb_fec_no_atresia_lm) 
plot(glucose_ambient_sim)

plotResiduals(glucose_amb_fec_no_atresia_lm)

testDispersion(glucose_amb_fec_no_atresia_lm)

testOutliers(glucose_ambient_sim)  
outlierTest(glucose_amb_fec_no_atresia_lm)

# Normality test:
shapiro.test(residuals(glucose_amb_fec_no_atresia_lm))

# qq plot
ggqqplot(residuals(lm(Glu..mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)))

# Transform data: square root 
glucose_ambient_sqrt <- Amb_Fec_No_Atresia_Samples %>%
  mutate(Glu..mmol.L. = sqrt(Glu..mmol.L.))

# Rerun lm model with square root transformed data
glucose_amb_fec_no_atresia_lm_sqrt <- lm(Glu..mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = glucose_ambient_sqrt)
summary(glucose_amb_fec_no_atresia_lm_sqrt)

glucose_amb_fec_sqrt_sim <- simulateResiduals(fittedModel = glucose_amb_fec_no_atresia_lm_sqrt) 
plot(glucose_amb_fec_sqrt_sim)

plotResiduals(glucose_amb_fec_no_atresia_lm_sqrt)

testDispersion(glucose_amb_fec_no_atresia_lm_sqrt)

# Residuals of model for shapiro test
glucose_amb_fec_no_atresia_lm_res <- residuals(glucose_amb_fec_no_atresia_lm_sqrt) 

# Normality test
shapiro.test(glucose_amb_fec_no_atresia_lm_res) 


# Parametric variance test: bartlett's test
# Require at least 2 obs for each group
#bartlett.test(Glu..mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = glucose_ambient_sqrt) 

# Nonparametric variance test (Levene's test)
# NA for quantitative explanatory variables
# leveneTest(Glu..mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = glucose_ambient_sqrt)

```

Residuals Plot (if significant)
```{r}
# glucose
# Ambient samples

# ggplot with geom_smooth(aes(x=,y=)), method = "lm")

glucose_ambient_lm_scatterplot <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Glu..mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Glucose", x = "Weight Adjusted Fecudnity", y = "Glucose (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        plot.title = element_text(size = 25, hjust = 0.5),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(glucose_ambient_lm_scatterplot)

ggsave(filename = "data-images/glucose_ambient_lm_scatterplot.pdf", plot = glucose_ambient_lm_scatterplot, device = "pdf")
ggsave(filename = "data-images/glucose_ambient_lm_scatterplot.png", plot = glucose_ambient_lm_scatterplot, device = "png")

```


# Sodium 

```{r}
# Na+

# sodium boxplot

sodium_ambient_fec_class_boxplot <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Na...mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = Na...mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Sodium", x = "Fecundity Class", y = "Sodium (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(sodium_ambient_fec_class_boxplot)

ggsave(filename = "data-images/sodium_ambient_fec_class_boxplot.pdf", plot = sodium_ambient_fec_class_boxplot, device = "pdf")
ggsave(filename = "data-images/sodium_ambient_fec_class_boxplot.png", plot = sodium_ambient_fec_class_boxplot, device = "png")

# sodium ambient no atresia scatterplot

sodium_amb_fec_no_atresia_scatterplot <- Ambient_Samples %>%
  ggplot() + 
  geom_point(aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Na...mmol.L.), colour = "black") +
  labs(title = "Sodium", x = "Weight Adjusted Fecundity", y = "Sodium (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(sodium_amb_fec_no_atresia_scatterplot)

ggsave(filename = "data-images/sodium_amb_fec_no_atresia_scatterplot.pdf", plot = sodium_amb_fec_no_atresia_scatterplot, device = "pdf")
ggsave(filename = "data-images/sodium_amb_fec_no_atresia_scatterplot.pdf", plot = sodium_amb_fec_no_atresia_scatterplot, device = "png")

```


# Na+ Stat Tests


Differences: Between Fecundity Class
```{r}
# Na+
# Ambient ANOVA Test

# Testing for differences in ambient parturition success metrics
# One-way ANOVA (parametric) or Kruskal-Wallis test (nonparametric)

sodium_aov_ambient_fec <- aov(Na...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)
summary(sodium_aov_ambient_fec)


# If significant, Post Hoc Test: 
# - Tukey's HSD (parametric, normality & equal variance across groups)
# - Dunn's test (non-parametric, after Kruskal-Wallis test)

TukeyHSD(sodium_aov_ambient_fec)

na_ambient_fec_sim <- simulateResiduals(fittedModel = sodium_aov_ambient_fec) 
plot(na_ambient_fec_sim)

plotResiduals(na_ambient_fec_sim)

testDispersion(na_ambient_fec_sim)

testOutliers(na_ambient_fec_sim)  
outlierTest(sodium_aov_ambient_fec)

# Parametric tests

# Normality
shapiro.test(Ambient_Samples$Na...mmol.L.)

shapiro.test(residuals(aov(Na...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)))

# QQplot:
sodium_ambient_fec_res_qqplot <- ggqqplot(residuals(aov(Na...mmol.L. ~ Fecundity_Class, data = Ambient_Samples))) +
labs(title = "Ambient Sodium Residual QQplot",
     subtitle = "residuals(aov(Na...mmol.L. ~ Fecundity_Class, data = Ambient_Samples))",
                               x = "Sodium Theoretical Quantiles (Predicted values)",
                               y = "Sodium Sample Quantiles") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
print(sodium_ambient_fec_res_qqplot)


# Parametric Variance test (Bartlett's test): require at least 2 obs for each group
bartlett.test(Na...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric variance test (Levene's test):
leveneTest(Na...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric stat test: Kruskall Wallis
kruskal.test(Na...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric Post Hoc: Dunn's test
DunnTest(Na...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)


```

Correlations: Parameter to Numerical Fecundity (without Atresia IDs)
```{r}
# Na+
# Linear Model
sodium_amb_fec_no_atresia_lm <- lm(Na...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)
summary(sodium_amb_fec_no_atresia_lm)

sodium_ambient_sim <- simulateResiduals(fittedModel = sodium_amb_fec_no_atresia_lm) 
plot(sodium_ambient_sim)

plotResiduals(sodium_ambient_sim)

testDispersion(sodium_ambient_sim)

testOutliers(sodium_ambient_sim)  
outlierTest(sodium_amb_fec_no_atresia_lm)


# Normailty test
shapiro.test(residuals(sodium_amb_fec_no_atresia_lm))

# qq plot
ggqqplot(residuals(lm(Na...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)))


# Transform data: square root 
sodium_ambient_sqrt <- Amb_Fec_No_Atresia_Samples %>%
  mutate(Na...mmol.L. = sqrt(Na...mmol.L.))

# Rerun lm model with square root transformed data
sodium_amb_fec_no_atresia_lm_sqrt <- lm(Na...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = sodium_ambient_sqrt)
summary(sodium_amb_fec_no_atresia_lm_sqrt)

sodium_amb_fec_sqrt_sim <- simulateResiduals(fittedModel = sodium_amb_fec_no_atresia_lm_sqrt) 
plot(sodium_amb_fec_sqrt_sim)

plotResiduals(sodium_amb_fec_no_atresia_lm_sqrt)

testDispersion(sodium_amb_fec_no_atresia_lm_sqrt)

# Residuals of model for shapiro test
sodium_amb_fec_no_atresia_lm_res <- residuals(sodium_amb_fec_no_atresia_lm_sqrt) 

# Normality test
shapiro.test(sodium_amb_fec_no_atresia_lm_res) 


# Parametric variance test: bartlett's test
# Require at least 2 obs for each group
#bartlett.test(Na...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = sodium_ambient_sqrt) 

# Nonparametric variance test (Levene's test)
# NA for quantitative explanatory variables
# leveneTest(Na...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = sodium_ambient_sqrt)

```

Residuals Plot (if significant)
```{r}
# Na+
# Ambient samples

# ggplot with geom_smooth(aes(x=,y=)), method = "lm")

sodium_ambient_lm_scatterplot <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Na...mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Sodium", x = "Weight Adjusted Fecudnity", y = "Sodium (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        plot.title = element_text(size = 25, hjust = 0.5),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(sodium_ambient_lm_scatterplot)

ggsave(filename = "data-images/sodium_ambient_lm_scatterplot.pdf", plot = sodium_ambient_lm_scatterplot, device = "pdf")
ggsave(filename = "data-images/sodium_ambient_lm_scatterplot.png", plot = sodium_ambient_lm_scatterplot, device = "png")

```



# Chloride 

Chloride graphs
```{r}
# Cl- 

# Chloride boxplot 
chloride_ambient_fec_class_boxplot <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Cl...mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = Cl...mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Chloride", x = "Fecundity Class", y = "Chloride (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(chloride_ambient_fec_class_boxplot)

ggsave(filename = "data-images/chloride_ambient_fec_class_boxplot.pdf", plot = chloride_ambient_fec_class_boxplot, device = "pdf")
ggsave(filename = "data-images/chloride_ambient_fec_class_boxplot.png", plot = chloride_ambient_fec_class_boxplot, device = "png")

# Chloride Ambient No Atresia Scatterplot
chloride_amb_fec_no_atresia_scatterplot <- Amb_Fec_No_Atresia_Samples %>%
  ggplot() + 
  geom_point(aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Na...mmol.L.), colour = "black") +
  labs(title = "Chloride", x = "Weight Adjusted Fecundity", y = "Chloride (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(chloride_amb_fec_no_atresia_scatterplot)

ggsave(filename = "data-images/chloride_amb_fec_no_atresia_scatterplot.pdf", plot = chloride_amb_fec_no_atresia_scatterplot, device = "pdf")
ggsave(filename = "data-images/chloride_amb_fec_no_atresia_scatterplot.pdf", plot = chloride_amb_fec_no_atresia_scatterplot, device = "png")

```


# Cl- Stat Tests

Differences: Between Fecundity Class
```{r}
# Cl-
# Ambient ANOVA Test

# Testing for differences in ambient parturition success metrics
# One-way ANOVA (parametric) or Kruskal-Wallis test (nonparametric)

chloride_aov_ambient_fec <- aov(Cl...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)
summary(chloride_aov_ambient_fec)


# If significant, Post Hoc Test: 
# - Tukey's HSD (parametric, normality & equal variance across groups)
# - Dunn's test (non-parametric, after Kruskal-Wallis test)

TukeyHSD(chloride_aov_ambient_fec)

cl_ambient_fec_sim <- simulateResiduals(fittedModel = chloride_aov_ambient_fec) 
plot(cl_ambient_fec_sim)

plotResiduals(cl_ambient_fec_sim)

testDispersion(cl_ambient_fec_sim)

testOutliers(cl_ambient_fec_sim)  
outlierTest(chloride_aov_ambient_fec)

# Parametric tests

# Normality
shapiro.test(Ambient_Samples$Cl...mmol.L.)

shapiro.test(residuals(aov(Cl...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)))

# QQplot:
chloride_ambient_fec_res_qqplot <- ggqqplot(residuals(aov(Cl...mmol.L. ~ Fecundity_Class, data = Ambient_Samples))) +
labs(title = "Ambient Chloride Residual QQplot",
     subtitle = "residuals(aov(Cl...mmol.L. ~ Fecundity_Class, data = Ambient_Samples))",
                               x = "Chloride Theoretical Quantiles (Predicted values)",
                               y = "Chloride Sample Quantiles") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
print(chloride_ambient_fec_res_qqplot)


# Parametric Variance test (Bartlett's test): require at least 2 obs for each group
bartlett.test(Cl...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric variance test (Levene's test):
leveneTest(Cl...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric stat test: Kruskall Wallis
kruskal.test(Cl...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric Post Hoc: Dunns
DunnTest(Cl...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

```

Remove Outlier
```{r}
# Cl-

# Test outlier

cl_ambient_fec_sim <- simulateResiduals(fittedModel = chloride_aov_ambient_fec) 
plot(cl_ambient_fec_sim)

plotResiduals(cl_ambient_fec_sim)

testDispersion(cl_ambient_fec_sim)

testOutliers(cl_ambient_fec_sim)  
outlierTest(chloride_aov_ambient_fec)


# Find Outlier
boxplot(Ambient_Samples$Cl...mmol.L., horizontal = TRUE)

ggplot(data = Ambient_Samples, aes(x = Fecundity_Class, y = Cl...mmol.L., fill = Ambient.Or.OAH)) +
  geom_boxplot(aes(x = Fecundity_Class, y = Cl...mmol.L.)) +
  geom_point(aes(color = Ambient.Or.OAH), position = position_dodge(width = 0.75), alpha = 0.3, color = "black")

# Remove Outlier 
# cl_amb_no_outlier <- Ambient_Samples %>%
#   filter(Cl...mmol.L. !=)

# Rerun Stat Tests

# chloride_aov_outlier_removed <- aov(Cl...mmol.L. ~ Fecundity_Class, data = cl_amb_no_outlier)
# summary(chloride_aov_outlier_removed)
# 
# 
# TukeyHSD(chloride_aov_outlier_removed)


```


Correlations: Parameter to Numerical Fecundity (without Atresia IDs)
```{r}
# Cl-
# Linear Model
chloride_amb_fec_no_atresia_lm <- lm(Cl...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)
summary(chloride_amb_fec_no_atresia_lm)

chloride_ambient_sim <- simulateResiduals(fittedModel = chloride_amb_fec_no_atresia_lm) 
plot(chloride_ambient_sim)

plotResiduals(chloride_ambient_sim)

testDispersion(chloride_ambient_sim)

testOutliers(chloride_ambient_sim)  
outlierTest(chloride_amb_fec_no_atresia_lm)

# Shapiro Test
shapiro.test(residuals(chloride_amb_fec_no_atresia_lm))

# Residual QQ plot
ggqqplot(residuals(lm(Cl...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)))

# Transform data: square root 
chloride_ambient_sqrt <- Amb_Fec_No_Atresia_Samples %>%
  mutate(Cl...mmol.L. = sqrt(Cl...mmol.L.))

# Rerun lm model with square root transformed data
chloride_amb_fec_no_atresia_lm_sqrt <- lm(Cl...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = chloride_ambient_sqrt)
summary(chloride_amb_fec_no_atresia_lm_sqrt)

chloride_amb_fec_sqrt_sim <- simulateResiduals(fittedModel = chloride_amb_fec_no_atresia_lm_sqrt) 
plot(chloride_amb_fec_sqrt_sim)

plotResiduals(chloride_amb_fec_no_atresia_lm_sqrt)

testDispersion(chloride_amb_fec_no_atresia_lm_sqrt)

testOutliers(chloride_amb_fec_sqrt_sim)  
outlierTest(chloride_amb_fec_no_atresia_lm_sqrt)

# Residuals of model for shapiro test
chloride_amb_fec_no_atresia_lm_res <- residuals(chloride_amb_fec_no_atresia_lm_sqrt) 

# Normality test
shapiro.test(chloride_amb_fec_no_atresia_lm_res) 


# Parametric variance test: bartlett's test
# Require at least 2 obs for each group
#bartlett.test(Cl...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = chloride_ambient_sqrt) 

# Nonparametric variance test (Levene's test)
# NA for quantitative explanatory variables
# leveneTest(Cl...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = chloride_ambient_sqrt)

```


Residuals Plot (if significant)
```{r}
# Cl-
# Ambient samples

# ggplot with geom_smooth(aes(x=,y=)), method = "lm")

chloride_ambient_lm_scatterplot <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Cl...mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Chloride", x = "Weight Adjusted Fecudnity", y = "Chloride (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        plot.title = element_text(size = 25, hjust = 0.5),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(chloride_ambient_lm_scatterplot)

ggsave(filename = "data-images/chloride_ambient_lm_scatterplot.pdf", plot = chloride_ambient_lm_scatterplot, device = "pdf")
ggsave(filename = "data-images/chloride_ambient_lm_scatterplot.png", plot = chloride_ambient_lm_scatterplot, device = "png")

```

# Potassium

K+ graphs
```{r}
# K+ Boxplot 
potassium_ambient_fec_class_boxplot <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = K...mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = K...mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Potassium", x = "Fecundity Class", y = "Potassium (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(potassium_ambient_fec_class_boxplot)

ggsave(filename = "data-images/potassium_ambient_fec_class_boxplot.pdf", plot = potassium_ambient_fec_class_boxplot, device = "pdf")
ggsave(filename = "data-images/potassium_ambient_fec_class_boxplot.png", plot = potassium_ambient_fec_class_boxplot, device = "png")


# K+ Ambient No Atresia Scatterplot
potassium_amb_fec_no_atresia_scatterplot <- Amb_Fec_No_Atresia_Samples %>%
  ggplot() + 
  geom_point(aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = K...mmol.L.), colour = "black") +
  labs(title = "Potassium", x = "Weight Adjusted Fecundity", y = "Potassium (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(potassium_amb_fec_no_atresia_scatterplot)

ggsave(filename = "data-images/potassium_amb_fec_no_atresia_scatterplot.pdf", plot = potassium_amb_fec_no_atresia_scatterplot, device = "pdf")
ggsave(filename = "data-images/potassium_amb_fec_no_atresia_scatterplot.pdf", plot = potassium_amb_fec_no_atresia_scatterplot, device = "png")

```


# K+ Stat Tests

Differences: Between Fecundity Class
```{r}
# K+
# Ambient ANOVA Test

# Testing for differences in ambient parturition success metrics
# One-way ANOVA (parametric) or Kruskal-Wallis test (nonparametric)

potassium_aov_ambient_fec <- aov(K...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)
summary(potassium_aov_ambient_fec)


# If significant, Post Hoc Test: 
# - Tukey's HSD (parametric, normality & equal variance across groups)
# - Dunn's test (non-parametric, after Kruskal-Wallis test)

TukeyHSD(potassium_aov_ambient_fec)

k_ambient_fec_sim <- simulateResiduals(fittedModel = potassium_aov_ambient_fec) 
plot(k_ambient_fec_sim)

plotResiduals(k_ambient_fec_sim)

testDispersion(k_ambient_fec_sim)

testOutliers(k_ambient_fec_sim)  
outlierTest(potassium_aov_ambient_fec)


# Parametric tests

# Normality
shapiro.test(Ambient_Samples$K...mmol.L.)

shapiro.test(residuals(aov(K...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)))

# QQplot:
potassium_ambient_fec_res_qqplot <- ggqqplot(residuals(aov(K...mmol.L. ~ Fecundity_Class, data = Ambient_Samples))) +
labs(title = "Ambient Potassium Residual QQplot",
     subtitle = "residuals(aov(K...mmol.L. ~ Fecundity_Class, data = Ambient_Samples))",
                               x = "Potassium Theoretical Quantiles (Predicted values)",
                               y = "Potassium Sample Quantiles") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
print(potassium_ambient_fec_res_qqplot)


# Parametric Variance test (Bartlett's test): require at least 2 obs for each group
bartlett.test(K...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric variance test (Levene's test):
leveneTest(K...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric stat test: Kruskall Wallis
kruskal.test(K...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric stat test: Kruskall Wallis
kruskal.test(K...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric Post Hoc: Dunn's test
DunnTest(K...mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

```

Correlations: Parameter to Numerical Fecundity (without Atresia IDs)
```{r}
# K+
# Linear Model
potassium_amb_fec_no_atresia_lm <- lm(K...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)
summary(potassium_amb_fec_no_atresia_lm)

potassium_ambient_sim <- simulateResiduals(fittedModel = potassium_amb_fec_no_atresia_lm) 
plot(potassium_ambient_sim)

plotResiduals(potassium_amb_fec_no_atresia_lm)

testDispersion(potassium_amb_fec_no_atresia_lm)

testOutliers(chloride_ambient_sim)  
outlierTest(potassium_amb_fec_no_atresia_lm)

# Shapiro Test
shapiro.test(residuals(potassium_amb_fec_no_atresia_lm))

ggqqplot(residuals(lm(K...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)))

# Transform data: square root 
potassium_ambient_sqrt <- Amb_Fec_No_Atresia_Samples %>%
  mutate(K...mmol.L. = sqrt(K...mmol.L.))

# Rerun lm model with square root transformed data
potassium_amb_fec_no_atresia_lm_sqrt <- lm(K...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = potassium_ambient_sqrt)
summary(potassium_amb_fec_no_atresia_lm_sqrt)

potassium_amb_fec_sqrt_sim <- simulateResiduals(fittedModel = potassium_amb_fec_no_atresia_lm_sqrt) 
plot(potassium_amb_fec_sqrt_sim)

plotResiduals(potassium_amb_fec_no_atresia_lm_sqrt)

testDispersion(potassium_amb_fec_no_atresia_lm_sqrt)

# Residuals of model for shapiro test
potassium_amb_fec_no_atresia_lm_res <- residuals(potassium_amb_fec_no_atresia_lm_sqrt) 

# Normality test
shapiro.test(potassium_amb_fec_no_atresia_lm_res) 


# Parametric variance test: bartlett's test
# Require at least 2 obs for each group
# bartlett.test(K...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = potassium_ambient_sqrt)

# Nonparametric variance test (Levene's test)
# NA for quantitative explanatory variables
# leveneTest(K...mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = potassium_ambient_sqrt)

```


Residuals Plot (if significant)
```{r}
# K+
# Ambient samples

# ggplot with geom_smooth(aes(x=,y=)), method = "lm")

potassium_ambient_lm_scatterplot <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = K...mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Potassium", x = "Weight Adjusted Fecudnity", y = "Potassium (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        plot.title = element_text(size = 25, hjust = 0.5),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(potassium_ambient_lm_scatterplot)

ggsave(filename = "data-images/potassium_ambient_lm_scatterplot.pdf", plot = potassium_ambient_lm_scatterplot, device = "pdf")
ggsave(filename = "data-images/potassium_ambient_lm_scatterplot.png", plot = potassium_ambient_lm_scatterplot, device = "png")

```


# Calcium 

Calcium Graphs
```{r}
# Ca+2 boxplot
calcium_ambient_fec_class_boxplot <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Ca....mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = Ca....mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Calcium", x = "Fecundity Class", y = "Calcium (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(calcium_ambient_fec_class_boxplot)

ggsave(filename = "data-images/calcium_ambient_fec_class_boxplot.pdf", plot = calcium_ambient_fec_class_boxplot, device = "pdf")
ggsave(filename = "data-images/calcium_ambient_fec_class_boxplot.png", plot = calcium_ambient_fec_class_boxplot, device = "png")


# Calcium Ambient No Atresia scatterplot
calcium_amb_fec_no_atresia_scatterplot <- Ambient_Samples %>%
  ggplot() + 
  geom_point(aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Ca....mmol.L.), colour = "black") +
  labs(title = "Calcium", x = "Weight Adjusted Fecundity", y = "Calcium (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        title = element_text(size = 12),
        plot.title = element_text(size = 30, hjust = 0.5),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(calcium_amb_fec_no_atresia_scatterplot)

ggsave(filename = "data-images/calcium_amb_fec_no_atresia_scatterplot.pdf", plot = calcium_amb_fec_no_atresia_scatterplot, device = "pdf")
ggsave(filename = "data-images/calcium_amb_fec_no_atresia_scatterplot.pdf", plot = calcium_amb_fec_no_atresia_scatterplot, device = "png")


```


# Calcium Stat Tests


Differences: Between Fecundity Class
```{r}
# Ca+2
# Ambient ANOVA Test

# Testing for differences in ambient parturition success metrics
# One-way ANOVA (parametric) or Kruskal-Wallis test (nonparametric)

calcium_aov_ambient_fec <- aov(Ca....mmol.L. ~ Fecundity_Class, data = Ambient_Samples)
summary(calcium_aov_ambient_fec)


# If significant, Post Hoc Test: 
# - Tukey's HSD (parametric, normality & equal variance across groups)
# - Dunn's test (non-parametric, after Kruskal-Wallis test)

TukeyHSD(calcium_aov_ambient_fec)

ca_ambient_fec_sim <- simulateResiduals(fittedModel = calcium_aov_ambient_fec) 
plot(ca_ambient_fec_sim)

plotResiduals(ca_ambient_fec_sim)

testDispersion(ca_ambient_fec_sim)

testOutliers(ca_ambient_fec_sim)  
outlierTest(calcium_aov_ambient_fec)

# Parametric tests

# Normality
shapiro.test(Ambient_Samples$Ca....mmol.L.)

shapiro.test(residuals(aov(Ca....mmol.L. ~ Fecundity_Class, data = Ambient_Samples)))

# QQplot:
calcium_ambient_fec_res_qqplot <- ggqqplot(residuals(aov(Ca....mmol.L. ~ Fecundity_Class, data = Ambient_Samples))) +
labs(title = "Ambient Calcium Residual QQplot",
     subtitle = "residuals(aov(Ca....mmol.L. ~ Fecundity_Class, data = Ambient_Samples))",
                               x = "Calcium Theoretical Quantiles (Predicted values)",
                               y = "Calcium Sample Quantiles") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
print(calcium_ambient_fec_res_qqplot)


# Parametric Variance test (Bartlett's test): require at least 2 obs for each group
bartlett.test(Ca....mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric variance test (Levene's test):
leveneTest(Ca....mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric stat test: Kruskall Wallis
kruskal.test(Ca....mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

# Nonparametric Post Hoc: Dunns test
DunnTest(Ca....mmol.L. ~ Fecundity_Class, data = Ambient_Samples)

```

Correlations: Parameter to Numerical Fecundity (without Atresia IDs)
```{r}
# Ca+2
# Linear Model
calcium_amb_fec_no_atresia_lm <- lm(Ca....mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)
summary(calcium_amb_fec_no_atresia_lm)

calcium_ambient_lm_sim <- simulateResiduals(fittedModel = calcium_amb_fec_no_atresia_lm) 
plot(calcium_ambient_lm_sim)

plotResiduals(calcium_ambient_lm_sim)

testDispersion(calcium_ambient_lm_sim)

testOutliers(calcium_ambient_lm_sim)  
outlierTest(calcium_amb_fec_no_atresia_lm)

# Shapiro Test
shapiro.test(residuals(calcium_amb_fec_no_atresia_lm))

ggqqplot(residuals(lm(Ca....mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = Ambient_Samples)))

# Transform data: square root 
calcium_ambient_sqrt <- Amb_Fec_No_Atresia_Samples %>%
  mutate(Ca....mmol.L. = sqrt(Ca....mmol.L.))

# Rerun lm model with square root transformed data
calcium_amb_fec_no_atresia_lm_sqrt <- lm(Ca....mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = calcium_ambient_sqrt)
summary(calcium_amb_fec_no_atresia_lm_sqrt)

calcium_amb_fec_sqrt_sim <- simulateResiduals(fittedModel = calcium_amb_fec_no_atresia_lm_sqrt) 
plot(calcium_amb_fec_sqrt_sim)

plotResiduals(calcium_amb_fec_sqrt_sim)

testDispersion(calcium_amb_fec_sqrt_sim)

# Residuals of model for shapiro test
calcium_amb_fec_no_atresia_lm_res <- residuals(calcium_amb_fec_no_atresia_lm_sqrt) 

# Normality test
shapiro.test(calcium_amb_fec_no_atresia_lm_res) 


# Parametric variance test: bartlett's test
# Require at least 2 obs for each group
# bartlett.test(Ca....mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = calcium_ambient_sqrt)

# Nonparametric variance test (Levene's test)
# NA for quantitative explanatory variables
# leveneTest(Ca....mmol.L. ~ Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, data = calcium_ambient_sqrt)

```


Residuals Plot (if significant)
```{r}
# Ca+2
# Ambient samples

# ggplot with geom_smooth(aes(x=,y=)), method = "lm")

calcium_ambient_lm_scatterplot <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Ca....mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Calcium", x = "Weight Adjusted Fecudnity", y = "Calcium (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"),
        plot.title = element_text(size = 25, hjust = 0.5),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

print(calcium_ambient_lm_scatterplot)

ggsave(filename = "data-images/calcium_ambient_lm_scatterplot.pdf", plot = calcium_ambient_lm_scatterplot, device = "pdf")
ggsave(filename = "data-images/calcium_ambient_lm_scatterplot.png", plot = calcium_ambient_lm_scatterplot, device = "png")

```



# Summary graphs


Combined boxplots
```{r}
# Fecundity class boxplots 

ph_fec_class <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = pH)) +
  geom_point(aes(x = Fecundity_Class, y = pH), alpha = 0.5, colour = "black") +
  labs(title = "pH", x = "Fecundity Class", y = "pH") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))

hct_fec_class <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Hct....)) +
  geom_point(aes(x = Fecundity_Class, y = Hct....), alpha = 0.5, colour = "black") +
  labs(title = "Hematocrit", x = "Fecundity Class", y = "Hematocrit (%)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))
  

glu_fec_class <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Glu..mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = Glu..mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Glucose", x = "Fecundity Class", y = "Glucose (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))
  
  
na_fec_class <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Na...mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = Na...mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Sodium", x = "Fecundity Class", y = "Sodium (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))
  

cl_fec_class <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Cl...mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = Cl...mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Chloride", x = "Fecundity Class", y = "Chloride (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))
  

k_fec_class <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = K...mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = K...mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Potassium", x = "Fecundity Class", y = "Potassium (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))
  
  
ca_fec_class <- ggplot(data = Ambient_Samples) + 
  geom_boxplot(aes(x = Fecundity_Class, y = Ca....mmol.L.)) +
  geom_point(aes(x = Fecundity_Class, y = Ca....mmol.L.), alpha = 0.5, colour = "black") +
  labs(title = "Calcium", x = "Fecundity Class", y = "Calcium (mmol/L)") +
  facet_wrap(~ Ambient.Or.OAH) +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))
  

fec_class_boxplots <- ph_fec_class + hct_fec_class + glu_fec_class + na_fec_class + cl_fec_class + k_fec_class + ca_fec_class + plot_layout(guides = "collect")

fec_class_boxplots
  
```

All Scatterplots 
```{r}
# lm plots
ph_am_lm <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = pH)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "pH", x = "Weight Adjusted Fecudnity", y = "pH", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))

hct_am_lm <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Hct....)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Hematocrit", x = "Weight Adjusted Fecudnity", y = "Hematocrit (%)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))

glucose_am_lm <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Glu..mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Glucose", x = "Weight Adjusted Fecudnity", y = "Glucose (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))

sodium_am_lm <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Na...mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Sodium", x = "Weight Adjusted Fecudnity", y = "Sodium (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))

chloride_am_lm <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Cl...mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Chloride", x = "Weight Adjusted Fecudnity", y = "Chloride (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))

potassium_am_lm <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = K...mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Potassium", x = "Weight Adjusted Fecudnity", y = "Potassium (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))

calcium_am_lm <- ggplot(data = Ambient_Samples, aes(x = Weight_Adjusted_Fecundity_Fecundity.Mean_Weight, y = Ca....mmol.L.)) +
  geom_point() +
  geom_smooth(aes(group = 1), method = "lm") +
  labs(title = "Calcium", x = "Weight Adjusted Fecudnity", y = "Calcium (mmol/L)", color = "Category") +
  scale_y_continuous() +
  theme_classic() +
  theme(panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white", color = "black"))
        
ambient_lm_plots <- ph_am_lm + hct_am_lm + glucose_am_lm + sodium_am_lm + chloride_am_lm + potassium_am_lm + calcium_am_lm + plot_layout(guides = "collect")

ambient_lm_plots
```


